<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Home Insurance Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Load Poppins from Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />

  <!-- jsPDF (for PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --mainColour: #CDE730;
      --secondaryColour: #0056b3;
      --tertiaryColour: #0056b3;
    }

    body {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      background: #fff;
      overflow-x: hidden;
      margin: 0;
      padding: 0 0 40px; /* bottom spacing */
    }

    /* CALCULATOR CONTAINER */
    .calculator {
      background: #fff;
      padding: 40px 30px; /* Increased padding for better spacing */
      border-radius: 10px;
      max-width: 450px;
      margin: 40px auto;
      box-shadow: 0px 4px 10px rgba(0, 86, 179, 0.3);
      border: 2px solid var(--secondaryColour);
    }

    h2 {
      font-size: 26px; /* Increased heading size */
      color: var(--tertiaryColour);
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 15px 0 5px;
      font-size: 16px;
      color: var(--secondaryColour);
      font-weight: 600;
    }

    input,
    select {
      width: calc(100% - 10px); /* Ensures spacing from borders */
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--secondaryColour);
      border-radius: 5px;
      margin-bottom: 15px; /* spacing between elements */
      font-family: 'Poppins', sans-serif;
    }

    input[type="number"] {
      background: white;
      color: black;
      text-align: center;
      font-weight: bold;
    }

    /* RADIO GROUP */
    .radio-group label {
      font-size: 14px;
      font-weight: 400;
      display: inline-block;
      margin-right: 20px;
      cursor: pointer;
    }
    .radio-group input {
      margin-right: 5px;
    }

    /* OUTPUT TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    th, td {
      border: 1px solid var(--secondaryColour);
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: var(--secondaryColour);
      color: #fff;
      font-weight: 600;
    }

    /* DOWNLOAD BUTTON */
    .download-btn {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      color: #000;
      background: var(--mainColour);
      border: none;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      margin-top: 20px;
    }
    .download-btn:hover {
      background: #d2f048; /* Slightly lighter on hover */
    }

    .footer {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- CALCULATOR -->
  <div class="calculator">
    <h2>Home Insurance Calculator</h2>

    <!-- House Type -->
    <label for="houseType">House type</label>
    <select id="houseType">
      <option value="-1">Select value</option>
      <option value="0">Terraced; 2 bedrooms (typical size 78 sq. m)</option>
      <option value="1">Terraced; 3 bedrooms (typical size 98 sq. m)</option>
      <option value="2">Semi-detached; 3 bedrooms (typical size 98 sq. m)</option>
      <option value="3">Semi-detached; 4 bedrooms (typical size 115 sq. m)</option>
      <option value="4">Detached; 4 bedrooms (typical size 113 sq. m)</option>
      <option value="5">Detached Bungalow; 4 bedrooms (typical size 137 sq. m)</option>
    </select>

    <!-- Floor Area -->
    <label for="floorArea">Gross internal floor area (sq. m.)</label>
    <input type="number" id="floorArea" min="1" max="10000" value="100" />

    <!-- Separate Garage -->
    <label>Separate Garage</label>
    <div class="radio-group" id="garageOptions">
      <label><input type="radio" name="garage" value="0" checked />No Garage</label>
      <label><input type="radio" name="garage" value="22880" />Single Car Garage</label>
      <label><input type="radio" name="garage" value="40928" />Double Car Garage</label>
    </div>

    <!-- Higher Than Average -->
    <label for="higherAverage">Add For Higher Than Average</label>
    <input type="number" id="higherAverage" min="0" max="1000000" value="0" />

    <!-- Additional Externals -->
    <label for="externals">Additional Externals</label>
    <input type="number" id="externals" min="0" max="1000000" value="0" />

    <!-- Output Table -->
    <table id="summaryTable">
      <thead>
        <tr>
          <th style="width: 60%;">Name</th>
          <th style="width: 40%;">Value</th>
        </tr>
      </thead>
      <tbody id="summaryBody">
        <!-- Populated via JS -->
      </tbody>
    </table>

    <!-- PDF BUTTON -->
    <button class="download-btn" id="downloadPdfBtn">Download PDF</button>

    <div class="footer">
      Ensure you are not underinsured. Enter correct values to get more accurate results.
    </div>
  </div>

<script>
  /********************************************
   * Data + DOM
   ********************************************/
  const houseTypeLabels = [
    "Terraced; 2 bedrooms (typical size 78 sq. m)",
    "Terraced; 3 bedrooms (typical size 98 sq. m)",
    "Semi-detached; 3 bedrooms (typical size 98 sq. m)",
    "Semi-detached; 4 bedrooms (typical size 115 sq. m)",
    "Detached; 4 bedrooms (typical size 113 sq. m)",
    "Detached Bungalow; 4 bedrooms (typical size 137 sq. m)"
  ];

  const regionRates = {
    "Dublin Region":     [3190, 3010, 3190, 3020, 3300, 2860],
    "Cork Region":       [2845, 2680, 2860, 2720, 2980, 2690],
    "Galway Region":     [2833, 2629, 2750, 2610, 2814, 2580],
    "Waterford Region":  [2790, 2590, 2775, 2635, 2866, 2470],
    "Limerick Region":   [2740, 2547, 2733, 2591, 2800, 2465],
    "North West Region": [2633, 2432, 2528, 2428, 2639, 2368],
    "North East Region": [2865, 2640, 2770, 2690, 2840, 2520]
  };

  // DOM Elements
  const houseTypeEl    = document.getElementById("houseType");
  const floorAreaEl    = document.getElementById("floorArea");
  const garageRadios   = document.getElementsByName("garage");
  const higherAvgEl    = document.getElementById("higherAverage");
  const externalsEl    = document.getElementById("externals");
  const summaryBodyEl  = document.getElementById("summaryBody");
  const downloadBtn    = document.getElementById("downloadPdfBtn");

  /********************************************
   * Calculation & Rendering
   ********************************************/
  function calculateAndRender() {
    const houseTypeIndex = parseInt(houseTypeEl.value, 10);
    const floorArea      = parseFloat(floorAreaEl.value) || 0;
    const higherAvg      = parseFloat(higherAvgEl.value) || 0;
    const externals      = parseFloat(externalsEl.value) || 0;

    let selectedGarageValue = 0;
    for (let i = 0; i < garageRadios.length; i++) {
      if (garageRadios[i].checked) {
        selectedGarageValue = parseFloat(garageRadios[i].value) || 0;
        break;
      }
    }

    // Clear table
    summaryBodyEl.innerHTML = "";

    // House Type
    let houseTypeLabel = (houseTypeIndex >= 0) ? houseTypeLabels[houseTypeIndex] : "N/A";
    addRow("House Type", houseTypeLabel);

    // Floor Area
    addRow("Gross internal floor area (sq. m.)", floorArea + " sq m");

    // Garage
    if (selectedGarageValue === 0) {
      addRow("Separate Garage", "No Garage");
    } else {
      const garageTxt = (selectedGarageValue === 22880) ? "Single Car Garage" : "Double Car Garage";
      addRow("Separate Garage", garageTxt + " ( €" + formatNumber(selectedGarageValue) + " )");
    }

    // Higher Than Average
    addRow("Add For Higher Than Average", "€" + formatNumber(higherAvg));

    // Additional Externals
    addRow("Additional Externals", "€" + formatNumber(externals));

    // Region calculations
    if (houseTypeIndex >= 0) {
      for (const [regionName, costs] of Object.entries(regionRates)) {
        const rate   = costs[houseTypeIndex];
        const regionTotal = (rate * floorArea) + selectedGarageValue + higherAvg + externals;
        addRow(regionName, "€" + formatNumber(regionTotal));
      }
    }
  }

  function addRow(name, val) {
    const tr = document.createElement("tr");
    const tdName = document.createElement("td");
    const tdVal  = document.createElement("td");
    tdName.textContent = name;
    tdVal.textContent  = val;
    tr.appendChild(tdName);
    tr.appendChild(tdVal);
    summaryBodyEl.appendChild(tr);
  }

  function formatNumber(num) {
    return num.toLocaleString("en-IE", { minimumFractionDigits: 0 });
  }

  /********************************************
   * PDF Generation
   ********************************************/
  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    // Some base styling
    doc.setFont("Poppins", "normal");

    // Attempt to fetch your hosted logo (SVG)
    const logoUrl = "https://raw.githubusercontent.com/boshify/home-insurance-calculator/main/logo.svg";

    // Coordinates
    let leftX = 40;
    let topY  = 60;

    // 1) Insert Enviroleak Logo
    try {
      const logoBase64 = await convertSvgToBase64(logoUrl);
      // We'll scale it to ~80 wide
      doc.addImage(logoBase64, "SVG", leftX, 30, 80, 30);
    } catch (e) {
      // if CORS fails, skip logo
    }

    // 2) Title (right side or top)
    doc.setFontSize(14);
    doc.setFont(undefined, "bold");
    doc.text("Calculation of House Rebuilding Costs for Insurance Purposes", 300, 45, {
      maxWidth: 270,
    });

    doc.setFontSize(10);
    doc.setFont(undefined, "normal");
    doc.text(
      "This document is a summary of the data provided as part of the Enviroleak Calculator.\nPlease ensure that the assumptions are applicable for the house type you are making a rebuild cost estimation for.",
      300,
      60,
      { maxWidth: 270, lineHeightFactor: 1.4 }
    );

    // 3) Date/time
    doc.setFontSize(9);
    const now = new Date();
    doc.text("Calculator Completed on: " + now.toLocaleString(), 300, 105);

    // 4) "Assumptions" on the left column
    doc.setFontSize(10);
    doc.setFont(undefined, "bold");
    doc.text("Assumptions", leftX, topY);
    topY += 15;
    doc.setFont(undefined, "normal");
    const assumptionsText = [
      "• The rebuilding rates are for speculatively built homes (i.e. estate-type homes).",
      "• Figures are a MINIMUM base cost guide. Homeowners may add for better finishes.",
      "• No allowance for outbuildings (unless added above).",
      "• Figures allow for demolition costs, professional fees, and VAT.",
      "• Professional fees include architects, surveyors, engineers, etc.",
      "• House contents (furniture, carpets, etc.) are separate from building costs.",
    ].join("\n");

    const wrappedAssumptions = doc.splitTextToSize(assumptionsText, 220);
    doc.text(wrappedAssumptions, leftX, topY, { lineHeightFactor: 1.4 });
    // measure how far we got
    const assumptionsHeight = wrappedAssumptions.length * 14;
    const nextLeftColumnY   = topY + assumptionsHeight + 30;

    // 5) Summary Table on the right column
    // We'll gather the summary from the DOM
    let summaryData = gatherSummaryData();
    // We'll position the table at x=300, y=120
    let tableX = 300;
    let tableY = 120;

    doc.setFont(undefined, "bold");
    doc.text("Name", tableX, tableY);
    doc.text("Option/Unit", tableX + 160, tableY);
    doc.text("Value", tableX + 300, tableY);
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    // horizontal line under headings
    doc.line(tableX, tableY + 5, tableX + 370, tableY + 5);

    doc.setFont(undefined, "normal");
    let rowY = tableY + 20;
    summaryData.forEach((item) => {
      doc.text(item.name, tableX, rowY);
      doc.text(item.option, tableX + 160, rowY);
      doc.text(item.value, tableX + 300, rowY);
      rowY += 14;
    });

    // 6) Contact Info at bottom
    let finalY = Math.max(nextLeftColumnY, rowY + 20);
    if (finalY > 700) finalY = 700; // crude page limit

    doc.setFont(undefined, "bold");
    doc.text("Enviroleak Contact Info", leftX, finalY);
    doc.setFont(undefined, "normal");
    finalY += 14;
    const contactText = [
      "info@enviroleak.ie",
      "",
      "Dublin Office:",
      "13 Upper Baggot Street, 2nd Floor, Dublin 4, DO4W7K5",
      "(01) 539 4393",
      "",
      "Cork Office:",
      "88/90 Main St, Rathgoggan Middle, Charleville, Co. Cork, P56 HC86",
      "(063) 732 11",
      "",
      "Galway Office:",
      "Galway Technology Centre, Mervue Business Park, Galway, H91D932",
      "(091) 396443",
      "",
      "Carlow Office:",
      "Loughmartin Business Park, Bunclody Road, Tullow, Carlow, R93T6CD",
      "(059) 9100464"
    ];
    doc.text(contactText, leftX, finalY, { lineHeightFactor: 1.3 });

    // Save
    doc.save("HomeInsuranceEstimate.pdf");
  }

  // Utility to gather the same table data from the DOM
  function gatherSummaryData() {
    const data = [];
    const rows = document.querySelectorAll("#summaryBody tr");
    rows.forEach((tr) => {
      const tds = tr.querySelectorAll("td");
      if (tds.length === 2) {
        // We'll break the first cell into "Name" & "Option/Unit" if relevant
        const nameCell = tds[0].textContent.trim();
        const valCell  = tds[1].textContent.trim();

        // For the "Separate Garage" row, for example, we might parse out "No Garage"
        // We'll do a simplistic approach: if the name is "House Type," the option is blank
        let itemName = nameCell;
        let itemOption = "";
        // If nameCell is "Separate Garage" but the value says "Single Car Garage ( €22,880 )",
        // we can split. We'll do a naive parse:
        if (nameCell === "Separate Garage") {
          itemOption = valCell.replace(/\(.*\)/, "").trim(); // remove the ( €22,880 ) part
        } else if (nameCell === "House Type") {
          itemOption = "";
        } else if (nameCell === "Gross internal floor area (sq. m.)") {
          itemOption = "sq. m.";
        } else {
          // For region rows or others, we can keep it blank or parse differently
        }

        data.push({
          name: itemName,
          option: itemOption,
          value: valCell
        });
      }
    });
    return data;
  }

  // Utility: Convert external SVG to base64
  async function convertSvgToBase64(url) {
    const res = await fetch(url);
    const text = await res.text();
    return "data:image/svg+xml;base64," + btoa(text);
  }

  /********************************************
   * Event Listeners
   ********************************************/
  houseTypeEl.addEventListener("change", calculateAndRender);
  floorAreaEl.addEventListener("input", calculateAndRender);
  higherAvgEl.addEventListener("input", calculateAndRender);
  externalsEl.addEventListener("input", calculateAndRender);
  for (let i = 0; i < garageRadios.length; i++) {
    garageRadios[i].addEventListener("change", calculateAndRender);
  }
  downloadBtn.addEventListener("click", downloadPDF);

  window.addEventListener("DOMContentLoaded", calculateAndRender);
</script>
</body>
</html>
